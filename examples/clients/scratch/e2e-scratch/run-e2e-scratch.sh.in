#!/bin/bash

# clean up previous session
killall aseba{dummynode,switch,massloader,http,scratch}
for i in 0 1 2 3 4 5 6 7 8; do ASEBADUMMYNODE $i & done

# localhost:3000 is a switch with 4 cooperating nodes:
#   dummynode-0 targetId=1 aeslId=1 LISTENER1
#   dummynode-1 targetId=2 aeslId=2 LISTENER2
#   dummynode-2 targetId=3 aeslId=3 LISTENER3
#   dummynode-3 targetId=4 aeslId=4 CLOCK
ASEBASCRATCH -p 3000 -a ping0123.aesl \
    $(for i in 0 1 2 3; do echo 'tcp:;port='$[ 33333 + $i ]; done) 1>&2 &

# localhost:3001 is a switch with 5 cooperating nodes:
#   dummynode-4 targetId=5 aeslId=1 LISTENER1
#   dummynode-5 targetId=6 aeslId=1 LISTENER1 (same role as dummynode-4)
#   dummynode-6 targetId=7 aeslId=4 CLOCK)
#   dummynode-7 targetId=8 aeslId=2 LISTENER2 (same id dummynode-5)
#   dummynode-8 targetId=9 aeslId=3 LISTENER3
ASEBASCRATCH -p 3001 -a ping0123.aesl \
    'tcp:;port=33337;remapTarget=5;remapLocal=1' \
    'tcp:;port=33338;remapAesl=1;remapTarget=6' \
    'tcp:;port=33339;remapAesl=4;remapTarget=7' \
    'tcp:;port=33341;remapAesl=3;remapTarget=9' \
    'tcp:;port=33340;remapAesl=2;remapTarget=8;remapLocal=6' 1>&2 &

sleep 10 # let switches start up

# run e2e tests
# jasmine-node --verbose --color *_spec.js
jasmine-node [1-4]*_spec.js
status=$?

# optional tests with a real Thymio-II
[ -x "DASHELPORTLIST" ] && DASHELPORTLIST | grep -qi thymio.ii &&
    ( ASEBASCRATCH -p 3002 -a thymio_motion.aesl 'ser:name=Thymio-II' & ) &&
    sleep 5 &&
    jasmine-node 5-thymio-II_spec.js

# clean up
[ -z "$(jobs -p)" ] || kill %%

exit $status
